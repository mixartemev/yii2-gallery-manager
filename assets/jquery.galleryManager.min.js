(function($){"use strict";var galleryDefaults={csrfToken:$("meta[name=csrf-token]").attr("content"),csrfTokenName:$("meta[name=csrf-param]").attr("content"),nameLabel:"Name",descriptionLabel:"Description",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[],editable:true,beforeAdd:"",afterAdd:"",beforeEdit:"",afterEdit:"",beforeRemove:"",afterRemove:"",beforeUpload:"",afterUpload:"",sortStop:""};function galleryManager(el,options){var opts=$.extend({},galleryDefaults,options);var csrfParams=opts.csrfToken?"&"+opts.csrfTokenName+"="+opts.csrfToken:"";var photos={};var $gallery=$(el);if(!opts.hasName){if(!opts.hasDesc){$gallery.addClass("no-name-no-desc");$(".edit_selected",$gallery).hide()}else $gallery.addClass("no-name")}else if(!opts.hasDesc)$gallery.addClass("no-desc");var $sorter=$(".sorter",$gallery);var $images=$(".images",$sorter);var $editorModal=$(".editor-modal",$gallery);var $progressOverlay=$(".progress-overlay",$gallery);var $uploadProgress=$(".upload-progress",$progressOverlay);var $editorForm=$(".form",$editorModal);function htmlEscape(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function createEditorElement(e,t,o,a,s){var r='<div class="photo-editor row">'+'<div class="col-xs-6">'+'<img src="'+htmlEscape(t)+'"  style="max-width:100%;">'+"</div>"+'<div class="col-xs-6">'+(opts.hasName?'<div class="form-group">'+'<label class="control-label" for="photo_name_'+e+'">'+opts.nameLabel+":</label>"+'<input class="form-control" type="text" name="photo['+e+'][name]" class="input-xlarge" value="'+htmlEscape(o)+'" id="photo_name_'+e+'"/>'+"</div>":"")+(opts.hasDesc?'<div class="form-group">'+'<label class="control-label" for="photo_description_'+e+'">'+opts.descriptionLabel+":</label>"+'<select class="form-control" name="photo['+e+'][description]" class="input-xlarge" id="photo_description_'+e+'">'+'<option value="8" '+(a=="Фото"?"selected":"")+">Фото</option>"+'<option value="10" '+(a=="Вид"?"selected":"")+">Вид</option>"+'<option value="9" '+(a=="Планировка"?"selected":"")+">Планировка</option>"+"</select>"+"</div>":"")+'<label><input type="checkbox" name="photo['+e+'][disable]"'+(s==1?"checked":"")+' value="1"/> Не выгружать</label>'+"</div>"+"</div>";return $(r)}var photoTemplate='<div class="photo">'+'<div class="image-preview"><img src=""/></div><div class="caption">';if(opts.hasDesc){photoTemplate+="<p></p>"}if(opts.hasName){photoTemplate+="<h5></h5>"}photoTemplate+="<span></span></div>";if(options.editable){photoTemplate+='<div class="actions">';if(opts.hasName||opts.hasDesc){photoTemplate+='<span class="editPhoto btn btn-primary btn-xs"><i class="glyphicon glyphicon-pencil glyphicon-white"></i></span> '}photoTemplate+='<span class="deletePhoto btn btn-danger btn-xs"><i class="glyphicon glyphicon-remove glyphicon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>'}var typeMap={2:"Главная",8:"Фото",10:"Вид",9:"Планировка"};var disableMap=["glyphicon glyphicon-ok-circle","glyphicon glyphicon-ban-circle"];function addPhoto(id,src,name,description,rank,disable){eval(opts.beforeAdd);var photo=$(photoTemplate);photos[id]=photo;photo.data("id",id);photo.data("rank",rank);$("img",photo).attr("src",src);if(opts.hasName){$(".caption h5",photo).text(name)}if(opts.hasDesc){$(".caption p",photo).text(typeMap[description])}$(".caption span",photo).attr("class",disableMap[disable]);$images.append(photo);eval(opts.afterAdd);return photo}function editPhotos(ids){eval(opts.beforeEdit);var l=ids.length;var form=$editorForm.empty();for(var i=0;i<l;i++){var id=ids[i];console.log($(".caption span",photo).attr("class"));var photo=photos[id],src=$("img",photo).attr("src"),name=$(".caption h5",photo).text(),description=$(".caption p",photo).text(),disable=disableMap.indexOf($(".caption span",photo).attr("class"));form.append(createEditorElement(id,src,name,description,disable))}if(l>0){$editorModal.modal("show")}eval(opts.afterEdit)}function removePhotos(ids){eval(opts.beforeRemove);$.ajax({type:"POST",url:opts.deleteUrl,async:true,data:"id[]="+ids.join("&id[]=")+csrfParams,success:function(e){if(e=="OK"){for(var t=0,o=ids.length;t<o;t++){photos[ids[t]].remove();delete photos[ids[t]]}}else{alert(e)}}});eval(opts.afterRemove)}function deleteClick(e){e.preventDefault();var t=$(this).closest(".photo");var o=t.data("id");removePhotos([o]);return false}function editClick(e){e.preventDefault();var t=$(this).closest(".photo");var o=t.data("id");editPhotos([o]);return false}function updateButtons(){var e=$(".photo.selected",$sorter).length;$(".select_all",$gallery).prop("checked",$(".photo",$sorter).length==e);if(e==0){$(".edit_selected, .remove_selected",$gallery).addClass("disabled")}else{$(".edit_selected, .remove_selected",$gallery).removeClass("disabled")}}function selectChanged(){var e=$(this);if(e.is(":checked"))e.closest(".photo").addClass("selected");else e.closest(".photo").removeClass("selected");updateButtons()}$images.on("click",".photo .deletePhoto",deleteClick).on("click",".photo .editPhoto",editClick).on("click",".photo .photo-select",selectChanged);if(options.editable){$(".images",$sorter).sortable({tolerance:"pointer"}).disableSelection().bind("sortstop",function(){var data=[];$(".photo",$sorter).each(function(){var e=$(this);if(e.find(".caption p").length&&e.find(".caption p").text().length){data.push("order["+e.data("id")+"]="+e.data("rank"))}else{$(this).sortable("cancel");return false}});$.ajax({type:"POST",url:opts.arrangeUrl,data:data.join("&")+csrfParams,dataType:"json"}).done(function(e){for(var t in e[t]){photos[t].data("rank",e[t])}});eval(opts.sortStop)})}if(window.FormData!==undefined){var uploadFileName=$(".afile",$gallery).attr("name");var multiUpload=function(files){if(files.length==0)return;eval(opts.beforeUpload);$progressOverlay.show();$uploadProgress.css("width","5%");var filesCount=files.length;var uploadedCount=0;var ids=[];for(var i=0;i<filesCount;i++){var fd=new FormData;fd.append(uploadFileName,files[i]);if(opts.csrfToken){fd.append(opts.csrfTokenName,opts.csrfToken)}var xhr=new XMLHttpRequest;xhr.open("POST",opts.uploadUrl,true);xhr.onload=function(){uploadedCount++;if(this.status==200){var e=JSON.parse(this.response);addPhoto(e["id"],e["preview"],e["name"],e["description"],e["rank"],e["disable"]);ids.push(e["id"])}else{}$uploadProgress.css("width",""+(5+95*uploadedCount/filesCount)+"%");if(uploadedCount===filesCount){$uploadProgress.css("width","100%");$progressOverlay.hide();if(opts.hasName||opts.hasDesc)editPhotos(ids)}};xhr.send(fd);xhr.onreadystatechange=function(){if(xhr.readyState!=4)return;if(xhr.status==200){eval(opts.afterUpload);console.log("afterUpload trigger")}}}};(function(){var e=$gallery[0];var t=false;var o=false;setInterval(function(){if(t!=o){if(t)e.classList.add("over");else e.classList.remove("over");o=t}},30);function a(e){e.preventDefault();t=true;return false}function s(){t=false;return false}function r(e){e.preventDefault();e.stopPropagation();var o=e.dataTransfer.files;multiUpload(o);t=false;return false}function l(){t=false}e.addEventListener("dragover",a,false);e.addEventListener("dragleave",s,false);e.addEventListener("drop",r,false);e.addEventListener("dragend",l,false)})();$(".afile",$gallery).attr("multiple","true").on("change",function(e){e.preventDefault();multiUpload(this.files)})}else{$(".afile",$gallery).on("change",function(e){e.preventDefault();var t=[];$progressOverlay.show();$uploadProgress.css("width","5%");var o={};if(opts.csrfToken)o[opts.csrfTokenName]=opts.csrfToken;$.ajax({type:"POST",url:opts.uploadUrl,data:o,files:$(this),iframe:true,processData:false,dataType:"json"}).done(function(e){addPhoto(e["id"],e["preview"],e["name"],e["description"],e["rank"],e["disable"]);t.push(e["id"]);$uploadProgress.css("width","100%");$progressOverlay.hide();if(opts.hasName||opts.hasDesc)editPhotos(t)})})}$(".save-changes",$editorModal).click(function(e){e.preventDefault();$.post(opts.updateUrl,$("input, textarea, select",$editorForm).serialize()+csrfParams,function(e){var t=e.length;for(var o=0;o<t;o++){var a=e[o];var s=photos[a.id];$("img",s).attr("src",a["src"]);if(opts.hasName)$(".caption h5",s).text(a["name"]);if(opts.hasDesc)$(".caption p",s).text(typeMap[a["description"]]);$(".caption span",s).attr("class",disableMap[a["disable"]])}$editorModal.modal("hide");$(".photo.selected",$sorter).each(function(){$(".photo-select",this).prop("checked",false)}).removeClass("selected");$(".select_all",$gallery).prop("checked",false);updateButtons()},"json")});$(".edit_selected",$gallery).click(function(e){e.preventDefault();var t=[];$(".photo.selected",$sorter).each(function(){t.push($(this).data("id"))});editPhotos(t);return false});$(".remove_selected",$gallery).click(function(e){e.preventDefault();var t=[];$(".photo.selected",$sorter).each(function(){t.push($(this).data("id"))});removePhotos(t)});$(".select_all",$gallery).change(function(){if($(this).prop("checked")){$(".photo",$sorter).each(function(){$(".photo-select",this).prop("checked",true)}).addClass("selected")}else{$(".photo.selected",$sorter).each(function(){$(".photo-select",this).prop("checked",false)}).removeClass("selected")}updateButtons()});for(var i=0,l=opts.photos.length;i<l;i++){var resp=opts.photos[i];addPhoto(resp["id"],resp["preview"],resp["name"],resp["description"],resp["rank"],resp["disable"])}}$.fn.galleryManager=function(e){if(this.length){this.each(function(){galleryManager(this,e)})}}})(jQuery);