(function(e){"use strict";var a={csrfToken:e("meta[name=csrf-token]").attr("content"),csrfTokenName:e("meta[name=csrf-param]").attr("content"),nameLabel:"Name",descriptionLabel:"Description",hasName:true,hasDesc:true,uploadUrl:"",deleteUrl:"",updateUrl:"",arrangeUrl:"",photos:[]};function t(t,s){var o=e.extend({},a,s);var n=o.csrfToken?"&"+o.csrfTokenName+"="+o.csrfToken:"";var i={};var r=e(t);if(!o.hasName){if(!o.hasDesc){r.addClass("no-name-no-desc");e(".edit_selected",r).hide()}else r.addClass("no-name")}else if(!o.hasDesc)r.addClass("no-desc");var l=e(".sorter",r);var c=e(".images",l);var d=e(".editor-modal",r);var p=e(".progress-overlay",r);var h=e(".upload-progress",p);var f=e(".form",d);function v(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function u(a,t,s,n,i){var r='<div class="photo-editor row">'+'<div class="col-xs-6">'+'<img src="'+v(t)+'"  style="max-width:100%;">'+"</div>"+'<div class="col-xs-6">'+(o.hasName?'<div class="form-group">'+'<label class="control-label" for="photo_name_'+a+'">'+o.nameLabel+":</label>"+'<input class="form-control" type="text" name="photo['+a+'][name]" class="input-xlarge" value="'+v(s)+'" id="photo_name_'+a+'"/>'+"</div>":"")+(o.hasDesc?'<div class="form-group">'+'<label class="control-label" for="photo_description_'+a+'">'+o.descriptionLabel+":</label>"+'<select class="form-control" name="photo['+a+'][description]" class="input-xlarge" id="photo_description_'+a+'">'+'<option value="0" '+(n=="Не выгружать"?"selected":"")+">Не выгружать</option>"+'<option value="2" '+(n=="Главная"?"selected":"")+">Главная</option>"+'<option value="8" '+(n=="Фото"?"selected":"")+">Фото</option>"+'<option value="10" '+(n=="Вид"?"selected":"")+">Вид</option>"+'<option value="9" '+(n=="Планировка"?"selected":"")+">Планировка</option>"+"</select>"+"</div>":"")+'<label><input type="checkbox" name="photo['+a+'][disable]"'+(i==1?"checked":"")+' value="1"/> Не выгружать</label>'+"</div>"+"</div>";return e(r)}var m='<div class="photo">'+'<div class="image-preview"><img src=""/></div><div class="caption">';if(o.hasDesc){m+="<p></p>"}if(o.hasName){m+="<h5></h5>"}m+='<span></span></div><div class="actions">';if(o.hasName||o.hasDesc){m+='<span class="editPhoto btn btn-primary btn-xs"><i class="glyphicon glyphicon-pencil glyphicon-white"></i></span> '}m+='<span class="deletePhoto btn btn-danger btn-xs"><i class="glyphicon glyphicon-remove glyphicon-white"></i></span>'+'</div><input type="checkbox" class="photo-select"/></div>';var g={2:"Главная",8:"Фото",10:"Вид",9:"Планировка"};var k=["glyphicon glyphicon-ok-circle","glyphicon glyphicon-ban-circle"];function b(a,t,s,n,r,l){var d=e(m);i[a]=d;d.data("id",a);d.data("rank",r);e("img",d).attr("src",t);if(o.hasName){e(".caption h5",d).text(s)}if(o.hasDesc){e(".caption p",d).text(g[n])}e(".caption span",d).attr("class",k[l]);c.append(d);return d}function y(a){var t=a.length;var s=f.empty();for(var o=0;o<t;o++){var n=a[o];console.log(e(".caption span",r).attr("class"));var r=i[n],l=e("img",r).attr("src"),c=e(".caption h5",r).text(),p=e(".caption p",r).text(),h=k.indexOf(e(".caption span",r).attr("class"));s.append(u(n,l,c,p,h))}if(t>0){d.modal("show")}}function D(a){e.ajax({type:"POST",url:o.deleteUrl,data:"id[]="+a.join("&id[]=")+n,success:function(e){if(e=="OK"){for(var t=0,s=a.length;t<s;t++){i[a[t]].remove();delete i[a[t]]}}else{alert(e)}}})}function x(a){a.preventDefault();var t=e(this).closest(".photo");var s=t.data("id");D([s]);return false}function w(a){a.preventDefault();var t=e(this).closest(".photo");var s=t.data("id");y([s]);return false}function T(){var a=e(".photo.selected",l).length;e(".select_all",r).prop("checked",e(".photo",l).length==a);if(a==0){e(".edit_selected, .remove_selected",r).addClass("disabled")}else{e(".edit_selected, .remove_selected",r).removeClass("disabled")}}function _(){var a=e(this);if(a.is(":checked"))a.closest(".photo").addClass("selected");else a.closest(".photo").removeClass("selected");T()}c.on("click",".photo .deletePhoto",x).on("click",".photo .editPhoto",w).on("click",".photo .photo-select",_);e(".images",l).sortable({tolerance:"pointer"}).disableSelection().bind("sortstop",function(){var a=[];e(".photo",l).each(function(){var t=e(this);a.push("order["+t.data("id")+"]="+t.data("rank"))});e.ajax({type:"POST",url:o.arrangeUrl,data:a.join("&")+n,dataType:"json"}).done(function(e){for(var a in e[a]){i[a].data("rank",e[a])}})});if(window.FormData!==undefined){var N=e(".afile",r).attr("name");var L=function(e){if(e.length==0)return;p.show();h.css("width","5%");var a=e.length;var t=0;var s=[];for(var n=0;n<a;n++){var i=new FormData;i.append(N,e[n]);if(o.csrfToken){i.append(o.csrfTokenName,o.csrfToken)}var r=new XMLHttpRequest;r.open("POST",o.uploadUrl,true);r.onload=function(){t++;if(this.status==200){var e=JSON.parse(this.response);b(e["id"],e["preview"],e["name"],e["description"],e["rank"],e["disable"]);s.push(e["id"])}else{}h.css("width",""+(5+95*t/a)+"%");if(t===a){h.css("width","100%");p.hide();if(o.hasName||o.hasDesc)y(s)}};r.send(i)}};(function(){var e=r[0];var a=false;var t=false;setInterval(function(){if(a!=t){if(a)e.classList.add("over");else e.classList.remove("over");t=a}},30);function s(e){e.preventDefault();a=true;return false}function o(){a=false;return false}function n(e){e.preventDefault();e.stopPropagation();var t=e.dataTransfer.files;L(t);a=false;return false}function i(){a=false}e.addEventListener("dragover",s,false);e.addEventListener("dragleave",o,false);e.addEventListener("drop",n,false);e.addEventListener("dragend",i,false)})();e(".afile",r).attr("multiple","true").on("change",function(e){e.preventDefault();L(this.files)})}else{e(".afile",r).on("change",function(a){a.preventDefault();var t=[];p.show();h.css("width","5%");var s={};if(o.csrfToken)s[o.csrfTokenName]=o.csrfToken;e.ajax({type:"POST",url:o.uploadUrl,data:s,files:e(this),iframe:true,processData:false,dataType:"json"}).done(function(e){b(e["id"],e["preview"],e["name"],e["description"],e["rank"],e["disable"]);t.push(e["id"]);h.css("width","100%");p.hide();if(o.hasName||o.hasDesc)y(t)})})}e(".save-changes",d).click(function(a){a.preventDefault();e.post(o.updateUrl,e("input, textarea, select",f).serialize()+n,function(a){var t=a.length;for(var s=0;s<t;s++){var n=a[s];var c=i[n.id];e("img",c).attr("src",n["src"]);if(o.hasName)e(".caption h5",c).text(n["name"]);if(o.hasDesc)e(".caption p",c).text(g[n["description"]]);e(".caption span",c).attr("class",k[n["disable"]])}d.modal("hide");e(".photo.selected",l).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected");e(".select_all",r).prop("checked",false);T()},"json")});e(".edit_selected",r).click(function(a){a.preventDefault();var t=[];e(".photo.selected",l).each(function(){t.push(e(this).data("id"))});y(t);return false});e(".remove_selected",r).click(function(a){a.preventDefault();var t=[];e(".photo.selected",l).each(function(){t.push(e(this).data("id"))});D(t)});e(".select_all",r).change(function(){if(e(this).prop("checked")){e(".photo",l).each(function(){e(".photo-select",this).prop("checked",true)}).addClass("selected")}else{e(".photo.selected",l).each(function(){e(".photo-select",this).prop("checked",false)}).removeClass("selected")}T()});for(var C=0,j=o.photos.length;C<j;C++){var P=o.photos[C];b(P["id"],P["preview"],P["name"],P["description"],P["rank"],P["disable"])}}e.fn.galleryManager=function(e){if(this.length){this.each(function(){t(this,e)})}}})(jQuery);